<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="s-calm2-api-impl-sub-flow" doc:id="86f745a4-cdc0-46b6-bdea-95ac04a3c1aa" >
		<ee:transform doc:name="Set Variables" doc:id="c0e32b6d-4b4c-4dc4-82f3-0ec504333009" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="flowName" resource="dwl/set-variables.dwl"></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<ee:transform doc:name="Request Payload For S CALM2" doc:id="55acd0d4-f72f-455c-9cbb-8377eda8f382" >
			<ee:message >
				<ee:set-payload resource="dwl/calm2-request-payload.dwl" />
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="header" ><![CDATA[%dw 2.0
output application/json
---
{
	custCode: payload.customer[0].legacyCustomerCode,
	accountNumber: payload.customer[0].accountNumber
}]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<logger level="INFO" doc:name="Logger" doc:id="0b824bed-1cd5-488f-926b-80cf05dfe039" message="#[payload]"/>
		<flow-ref doc:name="Log Process Entry" doc:id="3ee01fa3-7176-43ad-8d9c-0bf0370803cc" name="log-process-entry-sub-flow"/>
		<flow-ref doc:name="Audit Process Entry" doc:id="871609ca-4bc4-4645-831d-857c948066ed" name="audit-process-entry-sub-flow"/>
		<until-successful maxRetries="${retry.attempts}" doc:name="Until Successful" doc:id="c495d515-a1da-4a77-82c4-4e1d15cb452b" millisBetweenRetries="${retry.frequency}">
			<http:request method="PUT" doc:name="Invoke CALM2 API" doc:id="c7ac7b00-2584-467a-b113-c2dc764004ef" path="${calm2.path}" sendCorrelationId="ALWAYS" outputMimeType="application/json" config-ref="S_CALM2_Http_Request_configuration">
				<http:headers ><![CDATA[#[output application/java
---
{
	"Transaction-Id" : vars.transactionId,
	"client_secret" : p('calm2.client_secret'),
	"Authorization" : p('calm2.auth'),
	"X-CustCode" : vars.header.custCode,
	"Transaction-Start-Time" : vars.transactionStartTime,
	"X-ErpAccountNumber" : vars.header.accountNumber,
	"client_id" : p('calm2.client_id')
}]]]></http:headers>				
			

</http:request>
					

</until-successful>
		<ee:transform doc:name="Response Payload" doc:id="c12c7c73-377b-4d88-904c-41943c59bc49" >
			<ee:message >
				<ee:set-payload resource="dwl/build-api-response.dwl" />
			</ee:message>
			<ee:variables >
			</ee:variables>
		</ee:transform>
		<flow-ref doc:name="Audit Process Exit" doc:id="cdeea9f8-7a2b-4a1d-bd85-0aa78f9ca307" name="audit-process-exit-sub-flow"/>
		<flow-ref doc:name="Log Process Exit" doc:id="26dc9598-1833-4427-84e4-ad08d95e0fe7" name="log-process-exit-sub-flow"/>
	</sub-flow>
</mule>
