<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="s-calm2-api-impl-sub-flow" doc:id="86f745a4-cdc0-46b6-bdea-95ac04a3c1aa" >
		<ee:transform doc:name="Set Variables" doc:id="c0e32b6d-4b4c-4dc4-82f3-0ec504333009" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="flowName" resource="dwl/set-variables.dwl"></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<flow-ref doc:name="Log Process Entry" doc:id="3ee01fa3-7176-43ad-8d9c-0bf0370803cc" name="log-process-entry-sub-flow"/>
		<flow-ref doc:name="Audit Process Entry" doc:id="871609ca-4bc4-4645-831d-857c948066ed" name="audit-process-entry-sub-flow"/>
		<ee:transform doc:name="Request Payload For S CALM2" doc:id="55acd0d4-f72f-455c-9cbb-8377eda8f382">
			<ee:message>
				<ee:set-payload resource="dwl/calm2-request-payload.dwl" />
			</ee:message>
			<ee:variables>
				<ee:set-variable variableName="header"><![CDATA[%dw 2.0
output application/json
---
{
	custCode: payload.customer[0].legacyCustomerCode,
	accountNumber: payload.customer[0].accountNumber
}]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		
		<flow-ref doc:name="Call CALM2 Mock API" doc:id="efd2fe4b-3444-4a38-ae9c-09e12ed33743" name="orderlines-data-call-calm2-impl"/>
		<set-variable value="#[vars.apiName ++ &quot;: &quot; ++ 's-calm2-api-impl-sub-flow']" doc:name="Set Flow Name" doc:id="8f2bf621-4964-4052-a39a-27c3a4a39219" variableName="flowName"/>
		<flow-ref doc:name="Audit Process Exit" doc:id="cdeea9f8-7a2b-4a1d-bd85-0aa78f9ca307" name="audit-process-exit-sub-flow" />
		<flow-ref doc:name="Log Process Exit" doc:id="26dc9598-1833-4427-84e4-ad08d95e0fe7" name="log-process-exit-sub-flow"/>
	</sub-flow>
	<sub-flow name="orderlines-data-call-calm2-impl" doc:id="c9236012-5e11-48aa-9488-e6449a85e748" >
	<ee:transform doc:name="Set Variables" doc:id="0a8408ac-aa38-40e7-a66d-8b1bc2b6ad0e" >
			<ee:message >
			</ee:message>
			<ee:variables >
				<ee:set-variable variableName="flowName" resource="dwl/set-variables.dwl"></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<flow-ref doc:name="Log Process Entry" doc:id="5e75e8d7-9fe4-41fc-b98e-97a4c4b656a9" name="log-process-entry-sub-flow"/>
		<flow-ref doc:name="Audit Process Entry" doc:id="232326a2-c09f-4d38-8150-662f4300f423" name="audit-process-entry-sub-flow"/>
		<until-successful maxRetries="${retry.attempts}" doc:name="Until Successful" doc:id="861b47b5-9c43-472e-bd5c-54fc5adfa658" millisBetweenRetries="${retry.frequency}">
		<try doc:name="Try" doc:id="d95b841a-56fb-439e-b6bd-4fa818985744">
			<http:request method="PUT" doc:name="Invoke CALM2 Mock API" doc:id="ae27b2a5-ee76-44a4-91ff-560b101ce5dd" path="${calm2.path}" sendCorrelationId="ALWAYS" outputMimeType="application/json" config-ref="S_CALM2_Http_Request_configuration">
				<http:headers><![CDATA[#[output application/java
---
{
	"Transaction-Id" : vars.transactionId,
	"client_secret" : p('calm2.client_secret'),
	"Authorization" : attributes.headers.Authorization,
	"X-CustCode" : vars.header.custCode,
	"Transaction-Start-Time" : vars.transactionStartTime,
	"X-ErpAccountNumber" : vars.header.accountNumber,
	"client_id" : p('calm2.client_id')
}]]]></http:headers>

</http:request>
				<error-handler>
				<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="77f3d147-7c36-4441-902e-572974aaf7ad" type="HTTP:CONNECTIVITY, HTTP:INTERNAL_SERVER_ERROR, HTTP:METHOD_NOT_ALLOWED, HTTP:NOT_ACCEPTABLE, HTTP:PARSING, HTTP:RETRY_EXHAUSTED, HTTP:SECURITY, HTTP:SERVICE_UNAVAILABLE, HTTP:TIMEOUT, HTTP:TOO_MANY_REQUESTS, HTTP:UNAUTHORIZED, HTTP:UNSUPPORTED_MEDIA_TYPE, RETRY_EXHAUSTED,HTTP:RETRY_EXHAUSTED,HTTP:BAD_REQUEST, EXPRESSION, STREAM_MAXIMUM_SIZE_EXCEEDED">
					<set-variable value="#[write(error.muleMessage.payload,'application/json')]" doc:name="Set Error Log" doc:id="3d71c999-141e-423b-b139-75a8e0cbcb85" variableName="loggingPayload" />
					<flow-ref doc:name="Call to Logging Sub Flow" doc:id="5454a9ab-e31a-441c-a154-10f9f36beb86" name="logging-sub-flow" />
					<flow-ref doc:name="Audit Error Flow" doc:id="7fb2cbe4-ad81-409f-8ba8-3f8673cea1c4" name="audit-error-sub-flow" />
				</on-error-propagate>
				<on-error-continue enableNotifications="true" logException="true" doc:name="On Error Continue" doc:id="71dfcb6f-031e-4560-8f98-9431f83e1ea8" type="ANY">
					<set-variable value="#[error.errorMessage.attributes['statusCode']]" doc:name="Set Variable httpStatusCode" doc:id="a19b69a5-0da0-4fb9-96a4-c83b81c0a9cf" variableName="httpStatusCode" />
					<set-variable value="#['errors.calm2.response.status.' ++ vars.httpStatusCode]" doc:name="Set Variable Error Msg" doc:id="ddd6b0ab-ee4e-4336-9eb9-0a21044d992a" variableName="errorMsg"/>
					<set-variable value="#[p(vars.errorMsg)]" doc:name="Set Variable httpStatusMsg" doc:id="fba3cd7d-d7f5-48cc-83d5-66a53667c3f3" variableName="httpStatusMsg"/>
					<ee:transform doc:name="Response Error Message" doc:id="37d45548-f003-4e0a-a090-1dfa97eec656">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
    "responseCode": vars.httpStatusCode,
    "responseText":  vars.httpStatusMsg
}
]]></ee:set-payload>
			</ee:message>
							<ee:variables >
							</ee:variables>
		</ee:transform>
					</on-error-continue>
					
				</error-handler>
		</try>
		</until-successful>
		<flow-ref doc:name="Audit Process Exit" doc:id="8c269ce5-6d11-4cbb-957d-fd241ca60f63" name="audit-process-exit-sub-flow" />
		<flow-ref doc:name="Log Process Exit" doc:id="d4372687-f177-4715-8a41-fa59d837ae99" name="log-process-exit-sub-flow"/>
	</sub-flow>
</mule>
